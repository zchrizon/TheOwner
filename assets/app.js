const state={users:[],items:[],currentUserId:null}
const qs=s=>document.querySelector(s)
const qsa=s=>Array.from(document.querySelectorAll(s))
function load(){const u=localStorage.getItem('theowner_users');const i=localStorage.getItem('theowner_items');const c=localStorage.getItem('theowner_current');state.users=u?JSON.parse(u):[];state.items=i?JSON.parse(i):[];state.currentUserId=c||null}
function save(){localStorage.setItem('theowner_users',JSON.stringify(state.users));localStorage.setItem('theowner_items',JSON.stringify(state.items));localStorage.setItem('theowner_current',state.currentUserId||'')}
function normalizeSerial(s){return (s||'').toString().trim().replace(/\s+/g,'').toUpperCase()}
function currentUser(){return state.users.find(u=>u.id===state.currentUserId)||null}
function setActiveView(id){qsa('.view').forEach(v=>v.classList.remove('visible'));qs(`#view-${id}`).classList.add('visible');qsa('.nav-btn[data-view]').forEach(b=>b.classList.remove('active'));const nb=qs(`.nav-btn[data-view="${id}"]`);if(nb)nb.classList.add('active')}
function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}
function showAuth(){const user=currentUser();const authUser=qs('#authUser');const signInBtn=qs('#signInBtn');const signUpBtn=qs('#signUpBtn');const signOutBtn=qs('#signOutBtn');if(user){authUser.textContent=`${user.name} (${user.email})`;signOutBtn.classList.remove('hidden');signInBtn.classList.add('hidden');signUpBtn.classList.add('hidden')}else{authUser.textContent='';signOutBtn.classList.add('hidden');signInBtn.classList.remove('hidden');signUpBtn.classList.remove('hidden')}}
function ensureAuthGate(){const regGate=qs('#registerGate');const regForm=qs('#registerForm');const myGate=qs('#myGate');const myItems=qs('#myItems');if(currentUser()){regGate.textContent='';regForm.classList.remove('hidden');myGate.textContent='';renderMyItems()}else{regGate.innerHTML='<p>You need to sign in to register an item.</p>';regForm.classList.add('hidden');myGate.innerHTML='<p>You need to sign in to view your items.</p>';myItems.innerHTML=''}}
function openModal(content){const modal=qs('#modal');qs('#modalBody').innerHTML=content;modal.classList.remove('hidden')}
function closeModal(){qs('#modal').classList.add('hidden');qs('#modalBody').innerHTML=''}
function signUpForm(){return `<h3>Create Account</h3><form id="formSignUp"><label>Name</label><input id="suName" type="text" required><label>Email</label><input id="suEmail" type="email" required><label>Password</label><input id="suPass" type="password" required><button type="submit">Create Account</button></form>`}
function signInForm(){return `<h3>Sign In</h3><form id="formSignIn"><label>Email</label><input id="siEmail" type="email" required><label>Password</label><input id="siPass" type="password" required><button type="submit">Sign In</button></form>`}
function handleSignUp(){const name=qs('#suName').value.trim();const email=qs('#suEmail').value.trim().toLowerCase();const pass=qs('#suPass').value;if(state.users.some(u=>u.email===email))return alert('Email already registered');const user={id:uid(),name,email,pass};state.users.push(user);state.currentUserId=user.id;save();closeModal();showAuth();ensureAuthGate()}
function handleSignIn(){const email=qs('#siEmail').value.trim().toLowerCase();const pass=qs('#siPass').value;const user=state.users.find(u=>u.email===email&&u.pass===pass);if(!user)return alert('Invalid credentials');state.currentUserId=user.id;save();closeModal();showAuth();ensureAuthGate()}
function signOut(){state.currentUserId=null;save();showAuth();ensureAuthGate()}
function updateRegisterFields(){const type=qs('#itemType').value;const vinG=qs('#vinGroup');const imeiG=qs('#imeiGroup');const serialG=qs('#serialGroup');const vin=qs('#vin');const imei=qs('#imei');const serial=qs('#serial');vinG.classList.add('hidden');imeiG.classList.add('hidden');serialG.classList.add('hidden');vin.required=false;imei.required=false;serial.required=false;if(type==='car'){vinG.classList.remove('hidden');vin.required=true}else if(type==='phone'){imeiG.classList.remove('hidden');imei.required=true}else{serialG.classList.remove('hidden');serial.required=true}}
function registerItem(e){e.preventDefault();const user=currentUser();if(!user)return;const type=qs('#itemType').value;const name=qs('#itemName').value.trim();const status=qs('#status').value;const vin=qs('#vin').value.trim();const imei=qs('#imei').value.trim();const serial=qs('#serial').value.trim();let key='';if(type==='car')key=normalizeSerial(vin);else if(type==='phone')key=normalizeSerial(imei);else key=normalizeSerial(serial);if(!key)return alert('Provide required identifier');const item={id:uid(),ownerId:user.id,type,name,status,vin:normalizeSerial(vin),imei:normalizeSerial(imei),serial:normalizeSerial(serial),createdAt:Date.now()};state.items.push(item);save();qs('#registerForm').reset();updateRegisterFields();alert('Item registered');renderMyItems()}
function renderMyItems(){const user=currentUser();const wrap=qs('#myItems');if(!user){wrap.innerHTML='';return}const items=state.items.filter(i=>i.ownerId===user.id).sort((a,b)=>b.createdAt-a.createdAt);wrap.innerHTML=items.map(i=>{
  const badge=i.status==='stolen'?'<span class="badge stolen">Stolen</span>':'<span class="badge legit">Legit</span>';
  const idStr=i.type==='car'?(i.vin||''):(i.type==='phone'?(i.imei||''):(i.serial||''));
  return `<div class="item-card"><div style="display:flex;justify-content:space-between;align-items:center"><strong>${i.name}</strong>${badge}</div><div style="margin-top:6px">Type: ${i.type}</div><div>Identifier: ${idStr}</div><div style="display:flex;gap:8px;margin-top:8px"><button class="secondary" data-action="toggle" data-id="${i.id}">${i.status==='stolen'?'Mark Legit':'Mark Stolen'}</button><button class="secondary" data-action="delete" data-id="${i.id}">Delete</button></div></div>`
}).join('');wrap.querySelectorAll('button').forEach(b=>b.addEventListener('click',myItemAction))}
function myItemAction(e){const id=e.target.getAttribute('data-id');const act=e.target.getAttribute('data-action');const idx=state.items.findIndex(x=>x.id===id);if(idx<0)return;if(act==='toggle'){state.items[idx].status=state.items[idx].status==='stolen'?'legit':'stolen';save();renderMyItems()}else if(act==='delete'){state.items.splice(idx,1);save();renderMyItems()}}
function search(e){e.preventDefault();const q=normalizeSerial(qs('#searchSerial').value);const resBox=qs('#searchResult');const typeSel=qs('#searchType');const t=typeSel?typeSel.value:'car';if(!q){resBox.innerHTML='<p>Enter a value.</p>';return}let found=null;if(t==='car'){found=state.items.find(i=>normalizeSerial(i.vin)===q)}else if(t==='phone'){found=state.items.find(i=>normalizeSerial(i.imei)===q)}else{found=state.items.find(i=>normalizeSerial(i.serial)===q)}if(!found){resBox.innerHTML='<p>No record found.</p>';return}const owner=state.users.find(u=>u.id===found.ownerId);const idStr=found.type==='car'?(found.vin||''):(found.type==='phone'?(found.imei||''):(found.serial||''));const badge=found.status==='stolen'?'<span class="badge stolen">Stolen</span>':'<span class="badge legit">Legit</span>';resBox.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center"><strong>${found.name}</strong>${badge}</div><div>Type: ${found.type}</div><div>Identifier: ${idStr}</div><div style="margin-top:8px"><strong>Owner</strong><div>Name: ${owner?owner.name:'Unknown'}</div><div>Email: ${owner?owner.email:'Unknown'}</div></div>`}
function updateSearchFields(){const type=qs('#searchType').value;const lab=qs('#searchLabel');const inp=qs('#searchSerial');if(type==='car'){lab.textContent='VIN / Chassis';inp.placeholder='Vehicle VIN'}else if(type==='phone'){lab.textContent='IMEI';inp.placeholder='Phone IMEI'}else{lab.textContent='Serial Number';inp.placeholder='Serial Number'}}
function bind(){qsa('.nav-btn[data-view]').forEach(b=>b.addEventListener('click',()=>{setActiveView(b.getAttribute('data-view'));ensureAuthGate()}));qs('#signUpBtn').addEventListener('click',()=>{openModal(signUpForm());qs('#formSignUp').addEventListener('submit',e=>{e.preventDefault();handleSignUp()})});qs('#signInBtn').addEventListener('click',()=>{openModal(signInForm());qs('#formSignIn').addEventListener('submit',e=>{e.preventDefault();handleSignIn()})});qs('#signOutBtn').addEventListener('click',signOut);qs('#modalClose').addEventListener('click',closeModal);qs('#searchForm').addEventListener('submit',search);const st=qs('#searchType');if(st)st.addEventListener('change',updateSearchFields);qs('#itemType').addEventListener('change',updateRegisterFields);qs('#registerForm').addEventListener('submit',registerItem);const hb=qs('#homeBlocks');if(hb)hb.addEventListener('click',e=>{const el=e.target.closest('.block-card');if(!el)return;const act=el.getAttribute('data-action');if(act==='view'){setActiveView(el.getAttribute('data-view'));ensureAuthGate()}else if(act==='focus'){const t=el.getAttribute('data-target');const input=qs(`#${t}`);if(input)input.focus()}})}
function init(){load();showAuth();setActiveView('home');ensureAuthGate();updateRegisterFields();updateSearchFields();bind()}
document.addEventListener('DOMContentLoaded',init)